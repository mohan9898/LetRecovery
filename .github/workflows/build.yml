name: LetRecovery Auto Build
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 支持手动触发

jobs:
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 核心终极修改：安装Rust 1.80.0（edition2024正式稳定版）
      - name: Install Rust 1.80.0 (official stable edition2024)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.80.0  # 唯一能原生支持edition2024的最低稳定版
          override: true     # 强制覆盖系统所有旧版本
          profile: minimal   # 仅装核心工具，提升构建速度

      # 极致清理：删除所有旧文件+缓存，杜绝任何解析残留
      - name: Clean all old files and cargo cache (force)
        shell: pwsh
        run: |
          # 定义两个子项目路径
          $projPaths = @("./正常系统端", "./PE端")
          # 遍历删除子项目的Cargo.lock和target目录
          foreach ($path in $projPaths) {
            if (Test-Path "$path/Cargo.lock") { Remove-Item "$path/Cargo.lock" -Force -ErrorAction SilentlyContinue }
            if (Test-Path "$path/target") { Remove-Item "$path/target" -Recurse -Force -ErrorAction SilentlyContinue }
          }
          # 强制删除Cargo全局注册表（镜像源缓存的旧依赖清单，关键）
          if (Test-Path "$env:USERPROFILE\.cargo\registry") { Remove-Item "$env:USERPROFILE\.cargo\registry" -Recurse -Force -ErrorAction SilentlyContinue }
          # 强制删除Cargo git缓存
          if (Test-Path "$env:USERPROFILE\.cargo\git") { Remove-Item "$env:USERPROFILE\.cargo\git" -Recurse -Force -ErrorAction SilentlyContinue }

      # 保留清华镜像源，加速依赖下载（无需更换）
      - name: Configure Rust Tuna Mirror
        shell: pwsh
        run: |
          New-Item -Path $env:USERPROFILE\.cargo -Name config -ItemType File -Force -ErrorAction SilentlyContinue
          # 覆盖写入配置，避免旧配置残留
          Set-Content -Path $env:USERPROFILE\.cargo\config -Value @"
          [source.crates-io]
          replace-with = 'tuna'
          [source.tuna]
          registry = 'https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git'
          "@

      # 配置MSVC构建工具，解决link.exe缺失
      - name: Setup MSVC Build Tools
        uses: ilammy/msvc-dev-cmd@v1

      # 验证版本（必须输出1.80.0，否则编译必错）
      - name: Verify Rust/Cargo Version (MUST 1.80.0)
        run: |
          rustc --version # 预期输出：rustc 1.80.0 (xxx 2024-07-25)
          cargo --version # 预期输出：cargo 1.80.0 (xxx 2024-07-18)

      # 编译正常系统端
      - name: Build Normal System Version
        run: |
          cd 正常系统端
          cargo build --release --verbose

      # 编译PE端
      - name: Build PE Version
        run: |
          cd PE端
          cargo build --release --verbose
        working-directory: .

      # 缓存隔离：Key加入1.80.0，与旧版本彻底切割
      - name: Cache Cargo Dependencies (1.80.0 exclusive)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            **/target
          key: ${{ runner.os }}-cargo-1.80.0-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-1.80.0-

      # 打包产物（容错创建目录，避免路径不存在报错）
      - name: Package Build Artifacts
        shell: pwsh
        run: |
          # 容错创建目录，忽略已存在错误
          New-Item -Path ./release/NormalSystem -ItemType Directory -Force -ErrorAction SilentlyContinue
          New-Item -Path ./release/PE -ItemType Directory -Force -ErrorAction SilentlyContinue
          # 复制产物
          Copy-Item -Path ./正常系统端/target/release/* -Destination ./release/NormalSystem/ -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path ./PE端/target/release/* -Destination ./release/PE/ -Recurse -Force -ErrorAction SilentlyContinue

      # 上传产物（标注1.80.0，方便版本区分）
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LetRecovery-Windows-Release-1.80.0
          path: ./release/
          retention-days: 30
