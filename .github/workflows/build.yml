name: LetRecovery Auto Build
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build (Nightly)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 核心修改：安装Rust Nightly版（支持完整edition2024特性）
      - name: Install Rust Nightly (full edition2024 support)
        uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: nightly
          override: true
          profile: minimal

      # 极致清理：删除所有旧文件+全局缓存，杜绝解析残留
      - name: Clean all old files and cargo cache (force)
        shell: pwsh
        run: |
          $projPaths = @("./正常系统端", "./PE端")
          foreach ($path in $projPaths) {
            if (Test-Path "$path/Cargo.lock") { Remove-Item "$path/Cargo.lock" -Force -ErrorAction SilentlyContinue }
            if (Test-Path "$path/target") { Remove-Item "$path/target" -Recurse -Force -ErrorAction SilentlyContinue }
          }
          if (Test-Path "$env:USERPROFILE\.cargo\registry") { Remove-Item "$env:USERPROFILE\.cargo\registry" -Recurse -Force -ErrorAction SilentlyContinue }
          if (Test-Path "$env:USERPROFILE\.cargo\git") { Remove-Item "$env:USERPROFILE\.cargo\git" -Recurse -Force -ErrorAction SilentlyContinue }

      # 关键新增：启用Cargo所有不稳定特性（Nightly版必需，支持edition2024完整特性）
      - name: Enable all unstable Cargo features (Nightly required)
        shell: pwsh
        run: |
          New-Item -Path $env:USERPROFILE\.cargo -Name config -ItemType File -Force -ErrorAction SilentlyContinue
          Set-Content -Path $env:USERPROFILE\.cargo\config -Value @"
          [source.crates-io]
          replace-with = 'tuna'
          [source.tuna]
          registry = 'https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git'
          # 启用unstable特性，支持完整edition2024
          [unstable]
          edition2024 = true
          cargo-features = ["edition2024"]
          "@

      - name: Setup MSVC Build Tools
        uses: ilammy/msvc-dev-cmd@v1

      # 验证Nightly版本
      - name: Verify Rust/Cargo Nightly Version
        run: |
          rustc --version # 预期输出：rustc nightly-x86_64-pc-windows-msvc
          cargo --version # 预期输出：cargo nightly-x86_64-pc-windows-msvc

      # 编译正常系统端（Nightly版直接支持edition2024）
      - name: Build Normal System Version
        run: |
          cd 正常系统端
          cargo build --release --verbose

      # 编译PE端
      - name: Build PE Version
        run: |
          cd PE端
          cargo build --release --verbose
        working-directory: .

      # 缓存隔离：Nightly版专属缓存，与稳定版彻底切割
      - name: Cache Cargo Dependencies (Nightly exclusive)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            **/target
          key: ${{ runner.os }}-cargo-nightly-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-nightly-

      # 打包产物
      - name: Package Build Artifacts
        shell: pwsh
        run: |
          New-Item -Path ./release/NormalSystem -ItemType Directory -Force -ErrorAction SilentlyContinue
          New-Item -Path ./release/PE -ItemType Directory -Force -ErrorAction SilentlyContinue
          Copy-Item -Path ./正常系统端/target/release/* -Destination ./release/NormalSystem/ -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path ./PE端/target/release/* -Destination ./release/PE/ -Recurse -Force -ErrorAction SilentlyContinue

      # 上传产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LetRecovery-Windows-Release-Nightly
          path: ./release/
          retention-days: 30
