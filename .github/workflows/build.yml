name: LetRecovery Auto Build
于:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust 1.75.0
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.75.0
          override: true
          profile: minimal

      - name: Delete old Cargo.lock files
        run: |
          if (Test-Path ./正常系统端/Cargo.lock) { Remove-Item ./正常系统端/Cargo.lock -Force }
          if (Test-Path ./PE端/Cargo.lock) { Remove-Item ./PE端/Cargo.lock -Force }
        shell: pwsh

      - name: Configure Rust mirror
        run: |
          New-Item -Path $env:USERPROFILE\.cargo -Name config -ItemType File -Force
          Add-Content -Path $env:USERPROFILE\.cargo\config -Value @"
          [source.crates-io]
          replace-with = 'tuna'
          [source.tuna]
          registry = 'https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git'
          "@

      - name: Setup MSVC build tools
        uses: ilammy/msvc-dev-cmd@v1

      - name: Check Rust/Cargo version
        run: |
          rustc --version
          cargo --version

      - name: Build Normal System Version
        run: |
          cd 正常系统端
          cargo build --release --verbose

      - name: Build PE Version
        run: |
          cd PE端
          cargo build --release --verbose
        working-directory: .

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            **/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Package build artifacts
        run: |
          New-Item -Path ./release -ItemType Directory -Force
          Copy-Item -Path ./正常系统端/target/release/* -Destination ./release/NormalSystem/ -Recurse -Force
          Copy-Item -Path ./PE端/target/release/* -Destination ./release/PE/ -Recurse -Force
        shell: pwsh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LetRecovery-Windows-Release
          path: ./release/
          retention-days: 30
