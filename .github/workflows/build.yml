name: LetRecovery Auto Build
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 核心修改1：升级到Rust 1.79.0（edition2024正式稳定最低版）
      - name: Install Rust 1.79.0 (stable edition2024)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.79.0  # 关键：替换为正式支持edition2024的稳定版
          override: true
          profile: minimal

      # 核心修改2：超彻底清理旧文件+缓存，避免所有解析残留
      - name: Clean all old build files & cache
        shell: pwsh
        run: |
          # 清理两个子项目的Cargo.lock和target（核心）
          $projects = @("./正常系统端", "./PE端")
          foreach ($proj in $projects) {
            if (Test-Path "$proj/Cargo.lock") { Remove-Item "$proj/Cargo.lock" -Force }
            if (Test-Path "$proj/target") { Remove-Item "$proj/target" -Recurse -Force }
          }
          # 清理Cargo注册表缓存（镜像源下载的旧依赖清单，关键）
          if (Test-Path "$env:USERPROFILE\.cargo\registry") { Remove-Item "$env:USERPROFILE\.cargo\registry" -Recurse -Force }
          # 清理Cargo git缓存
          if (Test-Path "$env:USERPROFILE\.cargo\git") { Remove-Item "$env:USERPROFILE\.cargo\git" -Recurse -Force }

      # 保留清华镜像源，加速依赖下载（无需更换）
      - name: Configure Rust Tuna Mirror
        shell: pwsh
        run: |
          New-Item -Path $env:USERPROFILE\.cargo -Name config -ItemType File -Force
          Add-Content -Path $env:USERPROFILE\.cargo\config -Value @"
          [source.crates-io]
          replace-with = 'tuna'
          [source.tuna]
          registry = 'https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git'
          "@

      - name: Setup MSVC Build Tools
        uses: ilammy/msvc-dev-cmd@v1

      # 验证版本（确保输出1.79.0）
      - name: Verify Rust/Cargo Version
        run: |
          rustc --version # 预期：rustc 1.79.0 (xxx 2024-07-16)
          cargo --version # 预期：cargo 1.79.0 (xxx 2024-07-09)

      # 编译正常系统端
      - name: Build Normal System Version
        run: |
          cd 正常系统端
          cargo build --release --verbose

      # 编译PE端
      - name: Build PE Version
        run: |
          cd PE端
          cargo build --release --verbose
        working-directory: .

      # 核心修改3：缓存Key加入1.79.0，与旧版本缓存彻底隔离
      - name: Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            **/target
          key: ${{ runner.os }}-cargo-1.79.0-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-1.79.0-

      # 打包产物（英文目录，避免解析问题）
      - name: Package Build Artifacts
        shell: pwsh
        run: |
          New-Item -Path ./release -ItemType Directory -Force -ErrorAction SilentlyContinue
          New-Item -Path ./release/NormalSystem -ItemType Directory -Force -ErrorAction SilentlyContinue
          New-Item -Path ./release/PE -ItemType Directory -Force -ErrorAction SilentlyContinue
          Copy-Item -Path ./正常系统端/target/release/* -Destination ./release/NormalSystem/ -Recurse -Force
          Copy-Item -Path ./PE端/target/release/* -Destination ./release/PE/ -Recurse -Force

      # 上传产物（标注版本，方便区分）
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LetRecovery-Windows-Release-1.79.0
          path: ./release/
          retention-days: 30
