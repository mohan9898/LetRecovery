name: LetRecovery 自动编译
于:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows 编译
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      # 修复1：升级Rust工具链（指定完整版本+强制覆盖+最小化安装）
      - name: 安装 Rust 1.75+（含高版本Cargo）
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.75.0  # 改为完整版本号，避免版本模糊匹配
          override: true     # 强制覆盖系统原有旧版Rust/Cargo
          profile: minimal   # 仅安装核心工具，加快速度

      # 修复2：构建前删除旧Cargo.lock，让Cargo重新生成适配版本
      - name: 删除旧锁文件（解决v4版本不兼容）
        run: |
          # 分别删除两个子项目的旧Cargo.lock
          if (Test-Path ./正常系统端/Cargo.lock) { Remove-Item ./正常系统端/Cargo.lock -Force }
          if (Test-Path ./PE端/Cargo.lock) { Remove-Item ./PE端/Cargo.lock -Force }
        shell: pwsh

      - name: 配置 Rust 镜像源
        run: |
          New-Item -Path $env:USERPROFILE\.cargo -Name config -ItemType File -Force
          Add-Content -Path $env:USERPROFILE\.cargo\config -Value @"
          [source.crates-io]
          replace-with = 'tuna'
          [source.tuna]
          registry = 'https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git'
          "@

      - name: 安装 MSVC 构建工具
        uses: ilammy/msvc-dev-cmd@v1

      # 新增：验证Cargo版本（可选，用于调试确认）
      - name: 检查 Cargo/Rust 版本
        run: |
          rustc --version
          cargo --version  # 确认输出≥1.75.0

      # 修复3：编译时禁用--locked，允许Cargo重建锁文件
      - name: 编译正常系统端
        run: |
          cd 正常系统端
          cargo build --release --verbose  # 移除--locked，避免强制使用旧锁文件

      - name: 编译 PE 端
        run: |
          cd PE端
          cargo build --release --verbose
        working-directory: .  # 简化工作目录，避免路径嵌套问题

      # 修复4：优化缓存配置（可选，避免缓存旧锁文件）
      - name: 配置 Cargo 缓存
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            **/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: 打包产物
        run: |
          New-Item -Path ./release -ItemType Directory -Force
          Copy-Item -Path ./正常系统端/target/release/* -Destination ./release/正常系统端/ -Recurse -Force
          Copy-Item -Path ./PE端/target/release/* -Destination ./release/PE端/ -Recurse -Force

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: LetRecovery-Windows-Release
          path: ./release/
          retention-days: 30
